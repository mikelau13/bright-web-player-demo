<html>
<head>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script>
        jQuery.extend({
        /**
        * Returns get parameters.
        *
        * If the desired param does not exist, null will be returned
        *
        * @example value = $.getURLParam("paramName");
        */ 
        getUrlParam: function(strParamName){
            var strReturn = "";
            var strHref = window.location.href;
            var bFound=false;
            
            var cmpstring = strParamName + "=";
            var cmplen = cmpstring.length;

            if ( strHref.indexOf("?") > -1 ){
                var strQueryString = strHref.substr(strHref.indexOf("?")+1);
                var aQueryString = strQueryString.split("&");
                for ( var iParam = 0; iParam < aQueryString.length; iParam++ ){
                if (aQueryString[iParam].substr(0,cmplen)==cmpstring){
                    var aParam = aQueryString[iParam].split("=");
                    strReturn = aParam[1];
                    bFound=true;
                    break;
                }
                
                }
            }
            if (bFound==false) return null;
            return strReturn;
            }
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function() {
            var myPlayer = videojs.getPlayer('vjs_video_3');
            var autoPlayEvents = ['loadedmetadata', 'durationchange'];
            var videoList;
            var videoListIndex = parseInt($.getUrlParam("videoListIndex")) || 0;

            // better use API search instead of getVideo one by one
            // keep in mind that search-enable search key must be on server side for security reason
            
            myPlayer.catalog.getVideo('1649378259040711029', function(error, video){
                myPlayer.catalog.getVideo('1649292380622223566', function(error, video2){
                    myPlayer.catalog.getVideo('6068224625001', function(error, video3){
                        videoList = [video,video2, video3];
                        myPlayer.playlist(videoList, videoListIndex, function() {
                            //myPlayer.catalog.load(videoList, function() {
                            myPlayer.on(autoPlayEvents, autoplayableListener);
                        });
                        populateEndScreen(myPlayer);
                    });
                });
            });


            function populateEndScreen(myPlayer) {
                // Adding end screen listener
                myPlayer.on('ended', function() {
                    // START modal codes
                    var newElement = document.createElement('div');
                    newElement.setAttribute("id", "endScreenContainer");
                    newElement.setAttribute("style", "background-color: black;height:100%;width=100%;");

                    var endScreenPlaylist = myPlayer.player().playlist;
                    console.log('endScreenPlaylist', endScreenPlaylist());

                    newElement.innerHTML = 
                            '<p><strong>Counting down, 3, 2, 1 ... </strong></p>' +
                            '<p>Playing next - ' + endScreenPlaylist()[endScreenPlaylist.nextIndex()].name + '<img src="' + endScreenPlaylist()[endScreenPlaylist.nextIndex()].thumbnail + '"/></p>'
                    ;

                    $.each(endScreenPlaylist(), function( index, value ) {
                        if (index !== endScreenPlaylist.nextIndex()) {
                            newElement.innerHTML += '<p>More - ' + value.name + '</p>';
                        }
                    });
                
                    //newElement.id = "theModal";
                    var options = {};
                    options.content = newElement;
                    //options.label = 'labelX';
                    options.temporary = true; // If true the modal can only be opened once; it will be disposed as soon as it's closed
                    options.uncloseable = true; // If true the user will not be able to close the modal through the UI in the normal ways; programmatic closing is still possible

                    var ModalDialog = videojs.getComponent('ModalDialog');
                    var myModal = new ModalDialog(myPlayer, options);
                    myPlayer.addChild(myModal);
                    // END modal codes
                    myModal.open();
                    myPlayer.off('ended');
                    if (endScreenPlaylist()[endScreenPlaylist.nextIndex()]) {
                        window.setTimeout(function() {
                            window.location = window.location.origin + window.location.pathname + '?videoListIndex=' + endScreenPlaylist.nextIndex();
                        }, 3*1000);
                    }
                });
            }
                    
            function autoplayableListener(event) {
                console.log(event.type);
                // for live videos we want to listen for durationchange
                if (event.type === 'durationchange' && myPlayer.duration() === Infinity) {
                    attemptAutoplay();
                    myPlayer.off(autoPlayEvents, autoplayableListener);
                }
                if (event.type === 'loadedmetadata') {
                    attemptAutoplay();
                    myPlayer.off(autoPlayEvents, autoplayableListener);
                }
            }
        
            function attemptAutoplay() {
                var promise = myPlayer.play();
                if (promise !== undefined) {
                    promise.then(function () {
                    // Autoplay started!
                    }).
                    catch (function (error) {
                        alert('Autoplay was prevented, write codes here to handle.');
                    });
                }
            }
        });
    </script>
</head>
<body>
  <!-- advanced embed codes, better controls for developers -->
  <div class="vjs-playlist-player-container" style="max-width: 960px;">
	<video-js
		data-account="6057949425001"
		data-player="5iLQeK5T"
		data-embed="default"
		controls=""
		data-application-id=""
		class="vjs-fluid">
	</video-js>
  </div>
  <script src="//players.brightcove.net/6057949425001/5iLQeK5T_default/index.min.js"></script>
  <br/>Read this <a href="https://support.brightcove.com/brightcove-player-sample-navigate-video-end">to customize the end screen HTML</a>
  <br/>Combine with what you see in this demo, we can easily control how the video player redirects the page.
</body>
</html>
